# מדריך היררכיה למסמכים משפטיים - סיכום מלא

## 🎯 מטרת המדריך
מדריך זה מתעד את כל הפתרונות והטכניקות שפותחו לטיפול במסמכים משפטיים עם היררכיה של 3 רמות:
- **סעיפים ראשיים** (1.)
- **תת-סעיפים** (1.1.)
- **תת-תת-סעיפים** (1.1.1.)

---

## 📋 סיכום הבעיות שנפתרו

### 1. **בעיית ייצוא סעיפים היררכיים מצוואות**
**הבעיה:** סעיפים שהוספו ממחסן הסעיפים לא הופיעו בייצוא Word.

**הפתרון:**
- הוספת `customSections` ל-`ProfessionalWordExporter.tsx`
- יצירת פונקציה רקורסיבית `addSectionWithHierarchy`
- הוספת level 2 להגדרת המספור ב-Word

### 2. **בעיית מספור תת-תת-סעיפים**
**הבעיה:** תת-תת-סעיפים הופיעו רק עם הזחה, ללא מספור (1.1.1, 1.1.2).

**הפתרון:**
```typescript
// הוספת level 2 להגדרת המספור
{
  level: 2,
  format: LevelFormat.DECIMAL,
  text: "%1.%2.%3.",
  alignment: AlignmentType.RIGHT,
  style: {
    paragraph: {
      indent: { left: 2160, hanging: 360 },
      rightToLeft: true
    }
  }
}
```

### 3. **בעיית משתני מגדר בהסכמי שכר טרחה**
**הבעיה:** משתנים כמו `{{gender:המצווה|המצווה|המצווים}}` לא הוחלפו בערכים הנכונים.

**הפתרון:**
```typescript
// פונקציה להחלפת משתני מגדר
const applyGenderToText = (text: string) => {
  const clientsGender = getClientsGender();
  return text.replace(/\{\{gender:([^|]+)\|([^|]+)\|([^}]+)\}\}/g, (match, male, female, plural) => {
    switch (clientsGender) {
      case 'male': return male;
      case 'female': return female;
      case 'plural': return plural;
      default: return male;
    }
  });
};
```

---

## 🏗️ מבנה הנתונים הנדרש

### 1. **מבנה JSON לתבניות הסכמי שכר טרחה**
```json
{
  "צוואת_יחיד": {
    "serviceName": "עריכת צוואת יחיד",
    "clauses": [
      {
        "id": "cy_001",
        "title": "היקף השירות - עריכת צוואה",
        "text": "עורך הדין יערוך צוואה בכתב עבור {{gender:המצווה|המצווה|המצווים}}...",
        "subSections": [
          {
            "title": "מפגש ראשון - פעולות",
            "text": "במפגש הראשון יבוצעו הפעולות הבאות:",
            "subSubSections": [
              {
                "title": "תיעוד רצון המצווה",
                "text": "תיעוד מפורט ומדויק של רצון {{gender:המצווה|המצווה|המצווים}}..."
              }
            ]
          }
        ]
      }
    ]
  }
}
```

### 2. **מבנה Supabase לתבניות היררכיות**
```sql
-- טבלת section_templates
CREATE TABLE section_templates (
  id SERIAL PRIMARY KEY,
  title TEXT NOT NULL,
  main_section JSONB NOT NULL,
  child_sections JSONB[] NOT NULL,
  created_at TIMESTAMP DEFAULT NOW()
);
```

---

## 🔧 טכניקות יישום

### 1. **טעינת תבניות היררכיות מ-Supabase**
```typescript
// ב-useWarehouse.ts
const templateSections: WarehouseSection[] = [];
if (templatesData) {
  templatesData.forEach((template: any) => {
    templateSections.push({
      id: `template_${template.id}`,
      user_id: userId,
      title: template.main_section?.title || template.title,
      content: template.main_section?.content || '',
      category: 'template',
      level: 'main',
      sub_sections: template.child_sections || []
    });
  });
}
```

### 2. **ייצוא היררכי ל-Word**
```typescript
// פונקציה רקורסיבית להוספת סעיפים עם היררכיה
const addSectionWithHierarchy = (section: any, level: number = 0) => {
  let sectionContent = section.content || section.title;
  
  // החלפת משתנים
  sectionContent = applyGenderToText(sectionContent);
  
  // הוספת הסעיף לפי רמת ההיררכיה
  if (section.level === 'main' || level === 0) {
    sections.push(
      new Paragraph({
        numbering: { reference: 'main-numbering', level: 0 },
        alignment: AlignmentType.RIGHT,
        bidirectional: true,
        children: [
          new TextRun({
            text: sectionContent,
            font: 'David',
            rightToLeft: true,
            size: SIZES.normal
          })
        ]
      })
    );
  } else if (section.level === 'sub' || level === 1) {
    sections.push(
      new Paragraph({
        numbering: { reference: 'main-numbering', level: 1 },
        // ... קוד דומה
      })
    );
  } else if (section.level === 'sub-sub' || level === 2) {
    sections.push(
      new Paragraph({
        numbering: { reference: 'main-numbering', level: 2 },
        // ... קוד דומה
      })
    );
  }
  
  // הוספת תת-סעיפים אם קיימים
  if (section.sub_sections && section.sub_sections.length > 0) {
    const sortedSubSections = [...section.sub_sections].sort((a: any, b: any) => a.order - b.order);
    sortedSubSections.forEach((subSection: any) => {
      addSectionWithHierarchy(subSection, level + 1);
    });
  }
};
```

### 3. **הגדרת מספור Word עם 3 רמות**
```typescript
const numberingConfig = [
  {
    reference: "main-numbering",
    levels: [
      {
        level: 0,
        format: LevelFormat.DECIMAL,
        text: "%1.",
        alignment: AlignmentType.RIGHT,
        style: {
          paragraph: {
            indent: { left: 720, hanging: 360 },
            rightToLeft: true
          },
          run: { bold: true }
        }
      },
      {
        level: 1,
        format: LevelFormat.DECIMAL,
        text: "%1.%2.",
        alignment: AlignmentType.RIGHT,
        style: {
          paragraph: {
            indent: { left: 1440, hanging: 360 },
            rightToLeft: true
          }
        }
      },
      {
        level: 2,
        format: LevelFormat.DECIMAL,
        text: "%1.%2.%3.",
        alignment: AlignmentType.RIGHT,
        style: {
          paragraph: {
            indent: { left: 2160, hanging: 360 },
            rightToLeft: true
          }
        }
      }
    ]
  }
];
```

---

## 📝 תהליך עבודה מומלץ למסמכים חדשים

### 1. **הכנת התבנית ב-JSON**
- יצירת מבנה היררכי עם `subSections` ו-`subSubSections`
- הוספת משתני מגדר: `{{gender:זכר|נקבה|רבים}}`
- הוספת משתנים אחרים: `{{לקוח}}`, `{{צד}}` וכו'

### 2. **עדכון הקומפוננטה הרלוונטית**
- הוספת `customSections` state
- טעינת התבנית מה-JSON
- העברת הנתונים לייצואן

### 3. **עדכון הייצואן**
- הוספת פונקציה רקורסיבית
- החלפת משתני מגדר
- הוספת level 2 להגדרת המספור

### 4. **בדיקה מקומית**
```bash
npm run build
npm run dev
```

### 5. **פרסום**
```bash
git add .
git commit -m "הוספת תבנית היררכית חדשה"
git push origin main
```

---

## 🎯 דוגמאות למסמכים שניתן ליישם

### 1. **צוואות עם סעיפי משנה**
- סעיפי חלוקת עיזבון
- הוראות מיוחדות
- תנאים והגבלות

### 2. **הנחיות מקדימות עם סעיפי משנה**
- הוראות רפואיות
- הוראות משפטיות
- הוראות אישיות

### 3. **הסכמי ממון עם סעיפי משנה**
- חלוקת נכסים
- חובות והתחייבויות
- זכויות וחובות

### 4. **ייפוי כוח מתמשך עם סעיפי משנה**
- הוראות רפואיות
- הוראות רכוש
- הוראות אישיות

---

## ⚠️ נקודות חשובות לזכור

### 1. **מספור Word**
- תמיד להוסיף level 2 להגדרת המספור
- לוודא שההזחות נכונות (720, 1440, 2160)

### 2. **משתני מגדר**
- להשתמש בפורמט: `{{gender:זכר|נקבה|רבים}}`
- לוודא שהפונקציה `applyGenderToText` מוחלת

### 3. **מבנה JSON**
- `subSections` עבור תת-סעיפים
- `subSubSections` עבור תת-תת-סעיפים
- `order` עבור סידור

### 4. **בדיקות**
- תמיד לבדוק מקומית לפני פרסום
- לוודא שהמספור עובד בכל הרמות
- לבדוק החלפת משתנים

---

## 🚀 צעדים הבאים

1. **יישום על צוואות** - הוספת סעיפי משנה לצוואות
2. **יישום על הנחיות מקדימות** - הוספת היררכיה להנחיות
3. **יישום על מסמכים נוספים** - הרחבת המערכת
4. **אופטימיזציה** - שיפור ביצועים וקוד

---

**תאריך יצירה:** ${new Date().toLocaleDateString('he-IL')}  
**גרסה:** 1.0  
**סטטוס:** מוכן לשימוש
